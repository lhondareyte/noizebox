NANO_NAME=noizebox
NANO_SRC=/usr/src
NANO_DRIVE=ada0
NANO_KERNEL=NOIZEBOX
NANO_IMAGES=1

NANO_DATASIZE=4194304
NANO_DATADIR="/Applications"

# Flash 4Go
#NANO_MEDIASIZE=4110188544
NANO_MEDIASIZE=8027712
NANO_HEADS=16
NANO_SECTS=63

CONF_BUILD='
#NO_KLDLOAD=YES
NO_NETGRAPH=YES
NO_PAM=YES
'
CONF_INSTALL='
#NO_ACPI=YES
NO_BLUETOOTH=YES
NO_CVS=YES
NO_FORTRAN=YES
NO_HTML=YES
NO_LPR=YES
NO_MAN=YES
NO_SENDMAIL=YES
NO_SHAREDOCS=YES
NO_EXAMPLES=YES
NO_INSTALLLIB=YES
NO_CALENDAR=YES
NO_MISC=YES
NO_SHARE=YES
'
CONF_WORLD='
MALLOC_PRODUCTION=
WITHOUT_ACCT=
WITHOUT_AMD=
WITHOUT_ASSERT_DEBUG=
WITHOUT_ATM=
WITHOUT_AUDIT=
WITHOUT_AUTHPF=
WITHOUT_BIND=
WITHOUT_BIND_DNSSEC=
WITHOUT_BIND_ETC=
WITHOUT_BIND_LIBS_LWRES=
WITHOUT_BIND_MTREE=
WITHOUT_BIND_NAMED=
WITHOUT_BIND_UTILS=
WITHOUT_BLUETOOTH=
WITHOUT_BSNMP=
WITHOUT_CALENDAR=
WITHOUT_CAPSICUM=
WITHOUT_CDDL=
WITHOUT_CLANG=
#WITHOUT_CRYPT=
WITHOUT_CTM=
WITHOUT_CVS=
WITHOUT_DICT=
WITHOUT_EXAMPLES=
WITHOUT_FLOPPY=
WITHOUT_FREEBSD_UPDATE=
WITHOUT_GAMES=
WITHOUT_GCOV=
WITHOUT_GDB=
WITHOUT_GPIB=
WITHOUT_HTML=
WITHOUT_INET6=
WITHOUT_INFO=
#WITHOUT_INSTALLLIB=
WITHOUT_IPFILTER=
WITHOUT_IPFW=
WITHOUT_IPX=
WITHOUT_IPX_SUPPORT=
WITHOUT_JAIL=
WITHOUT_KERBEROS=
WITHOUT_KERBEROS_SUPPORT=
WITHOUT_KERNEL_SYMBOLS=
WITHOUT_LIB32=
WITHOUT_LOCALES=
WITHOUT_LOCATE=
WITHOUT_LPR=
WITHOUT_MAN=
WITHOUT_MAN_UTILS=
WITHOUT_MAIL=
WITHOUT_NCP=
WITHOUT_NDIS=
WITHOUT_NETCAT=
WITHOUT_NETGRAPH=
WITHOUT_NETGRAPH_SUPPORT=
WITHOUT_NIS=
WITHOUT_NLS=
WITHOUT_NLS_CATALOGS=
WITHOUT_NS_CACHING=
WITHOUT_NTP=
WITHOUT_OFED=
WITHOUT_OPENSSH=
#WITHOUT_OPENSSL=
WITHOUT_PAM=
WITHOUT_PAM_SUPPORT=
WITHOUT_PF=
WITHOUT_PPP= 
WITHOUT_PORTSNAP=
WITHOUT_QUOTAS=
WITHOUT_RCS=
WITHOUT_RCMDS=
WITHOUT_RESCUE=
WITHOUT_ROUTED=
WITHOUT_SENDMAIL=
WITHOUT_SHAREDOCS=
WITHOUT_SSP=
WITHOUT_SYSINSTALL=
WITHOUT_TCSH=
WITHOUT_TELNET=
WITHOUT_TEXTPROC=
WITHOUT_UTMPX=
WITHOUT_WIRELESS=
WITHOUT_WPA_SUPPLICANT_EAPOL=
WITHOUT_ZFS=
'

cust_nobeastie()
(
	touch ${NANO_WORLDDIR}/boot/loader.conf
	echo "beastie_disable=\"YES\"" >> ${NANO_WORLDDIR}/boot/loader.conf
)

cust_configure_systeme()
(
	LD_CONF="${NANO_WORLDDIR}/boot/loader.conf"
	rm -f ${NANO_WORLDDIR}/Applications/*
	#
	#echo "console=\"comconsole\"" >> ${LD_CONF}
	echo "autoboot_delay=\"0\"" >> ${LD_CONF}
	# 
	# Desactivation du second test memoire
	echo "hw.memtest.tests=0" >> ${LD_CONF}
	#
	# Desactivation attente USB au boot et au shutdown
	echo "hw.usb.no_boot_wait=1" >> ${LD_CONF}
	echo "hw.usb.no_shutdown_wait=1" >> ${LD_CONF}
	#
	# Bug pcm dead
	echo "hint.hdac.0.msi=\"0\"" >> ${NANO_WORLDDIR}/boot/device.hints
	#
	# Points de montage pour nano_upgrade.sh
	printf "/dev/ada0s4\t/Applications\tufs\tro\t0 0\n">> ${NANO_WORLDDIR}/etc/fstab
	printf "/dev/ada0s4\t/Upgrade\tufs\trw,noauto\t0 0\n">> ${NANO_WORLDDIR}/etc/fstab
	printf "/dev/ada0s4\t/Ramdisk\tufs\trw,noauto\t0 0\n">> ${NANO_WORLDDIR}/etc/fstab
)

cust_install_application()
(
	install -m 755 -o root -g wheel ../rsc/noizebox.rc.d ${NANO_WORLDDIR}/etc/rc.d/noizebox
	[ -d Noizebox/Frameworks/$(uname -s)/$(uname -m) ] && chflags noschg Noizebox/Frameworks/$(uname -s)/$(uname -m)/*
	rm -rf Noizebox
	mkdir -p Noizebox/Resources/SF2
	mkdir -p Noizebox/Frameworks/$(uname -s)/$(uname -m)
	mkdir -p Noizebox/Contents/$(uname -s)/$(uname -m)
	cp ../src/noizebox Noizebox/Contents/$(uname -s)/$(uname -m)/noizebox
	cp ../sf2/*.sf2 Noizebox/Resources/SF2
	cp ../sf2/soundfont.conf Noizebox/Resources
	cp ../rsc/termcap.db ${NANO_WORLDDIR}/usr/share/misc/
	cp ../rsc/termcap ${NANO_WORLDDIR}/usr/share/misc/
	install -m 755 ../rsc/noizebox.$(uname -s) Noizebox/noizebox
	ldd Noizebox/Contents/$(uname -s)/$(uname -m)/noizebox \
		| awk '!/not found/ && /=>/ {print $3}' \
		| while read l ; do cp $l Noizebox/Frameworks/$(uname -s)/$(uname -m)/ ; done
	install -m 755 -o root -g wheel  ../fluidsynth/src/.libs/libfluid*so.* Noizebox/Frameworks/$(uname -s)/$(uname -m)/
	ldd ../fluidsynth/src/.libs/libfluidsynth*so.* \
		| awk '!/not found/ && /=>/ {print $3}' \
		| while read l ; do install -m 755 -o root -g wheel  $l Noizebox/Frameworks/$(uname -s)/$(uname -m)/ ; done
	mkdir -p ${NANO_WORLDDIR}/Applications
	cd  Noizebox/Frameworks/$(uname -s)/$(uname -m)
	ln -s libfluidsynth*so.* libfluidsynth.so
	cd -
	chown -R root:wheel Noizebox
	rm -f ${NANO_WORLDDIR}/Applications/*
	mkdir -p ${NANO_WORLDDIR}/Ramdisk
	mkdir -p ${NANO_WORLDDIR}/Upgrade
	mkdir -p ${NANO_WORLDDIR}/media/flashdrive
	install -m 755 -o root -g wheel ../utils/Analyze/AnalyzeMIDI ${NANO_WORLDDIR}/usr/bin
	install -m 755 -o root -g wheel ../utils/Upgrade/nano_upgrade.sh ${NANO_WORLDDIR}/usr/bin/
	mkdir -p ${NANO_WORLDDIR}/usr/share/nanobsd
	install -m 644 -o root -g wheel ../utils/Upgrade/nano_upgrade.msg ${NANO_WORLDDIR}/usr/share/nanobsd/
	install -m 755 -o root -g wheel ../utils/Upgrade/tinyvt ${NANO_WORLDDIR}/usr/bin/
	install -m 644 -o root -g wheel ../utils/Upgrade/nanobsd.conf ${NANO_WORLDDIR}/etc/devd
	if [ -x /usr/local/sbin/fxload ] ; then
		install -m 755 -o root -g wheel /usr/local/sbin/fxload ${NANO_WORLDDIR}/usr/bin
		install -m 644 -o root -g wheel ../rsc/m-audio/m-audio.conf  ${NANO_WORLDDIR}/etc/devd
		install -m 644 -o root -g wheel ../rsc/midi-usb.conf  ${NANO_WORLDDIR}/etc/devd
		mkdir -p ${NANO_WORLDDIR}/usr/share/fxload/m-audio
		install -m 644 -o root -g wheel  ../rsc/m-audio/*ihx ${NANO_WORLDDIR}/usr/share/fxload/m-audio
	fi
)

cust_install_french()
(
	kmp=/usr/share/syscons/keymaps/
	mkdir -p ${NANO_WORLDDIR}${kmp}
	cp ${kmp}/fr.* ${NANO_WORLDDIR}${kmp}
	echo "keymap=\"fr.iso.acc.kbd\"" >> ${NANO_WORLDDIR}/etc/rc.conf
)

cust_install_packages()
{
	mkdir -p ${NANO_WORLDDIR}/packages
	cp -rp ../pkg/* ${NANO_WORLDDIR}/packages
	chroot ${NANO_WORLDDIR} sh -c 'cd packages; pkg_add -v *;cd ..;'
	rm -rf ${NANO_WORLDDIR}/packages
}

cust_install_ttys()
(
	printf "console\tnone\t\t\tunknown\toff secure\n" > ${NANO_WORLDDIR}/etc/ttys
	printf "ttyv0\t\"/usr/libexec/getty Pc\"\t\txterm\ton  secure\n" >> ${NANO_WORLDDIR}/etc/ttys
)

customize_cmd cust_install_files
customize_cmd cust_install_ttys
customize_cmd cust_configure_systeme
customize_cmd cust_install_application
customize_cmd cust_install_french
customize_cmd cust_nobeastie
